{"version":3,"sources":["../../src/datasource.js"],"names":["NetXMSDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","sessionId","basicAuth","withCredentials","_request","method","data","params","options","headers","datasourceRequest","then","response","get","query","buildQueryParameters","targets","includes","status","session","message","title","mapToTextValue","result","map","_","d","i","id","sort","a","b","localeCompare","parameters","interval","intervalMs","from","range","toISOString","to","JSON","stringify"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\n\nexport class NetXMSDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv)\n  {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.sessionId = 0;\n    this.basicAuth = instanceSettings.basicAuth;\n    this.withCredentials = instanceSettings.withCredentials;\n\n    this._request = function(method, url, data, params) {\n      var options = {\n        url: this.url + \"/\" + url,\n        method: method,\n        data: data,\n        headers: {},\n        params: params\n      };\n\n      if (this.basicAuth || this.withCredentials) {\n        options.withCredentials = true;\n      }\n      if (this.basicAuth) {\n        options.headers[\"Authorization\"] = this.basicAuth;\n      }\n      if (this.sessionId)\n        options.headers[\"Session-Id\"] = this.sessionId;\n\n      return backendSrv.datasourceRequest(options).then(response =>\n        {\n          if (typeof response.headers === 'function') {\n            if (response.headers(\"Session-Id\")) {\n              this.sessionId = response.headers(\"Session-Id\");\n            }\n          } else {\n            this.sessionId = response.headers.get(\"Session-Id\");\n          }\n          return response;\n        });\n    };\n  }\n\n  query(options)\n  {\n    var query = this.buildQueryParameters(options);\n    if (query.targets.includes(\"type\\\":\\\"Alarms\\\"\"))\n      var url = \"grafana/alarms\";\n    else\n      var url = \"grafana/datacollection\";\n\n    return this._request('GET', url, null, query);\n  }  \n\n  testDatasource()\n  {\n    return this._request('POST', 'sessions', null, null).then(response =>\n    {\n      if (response.status === 200)\n      {\n        this._request('DELETE', 'sessions/' + response.data.session, null, null);\n        return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n      }\n    });\n  }\n\n  /*\n   * Not implemented yet\n   */\n  /*annotationQuery(options) {\n    var query = this.templateSrv.replace(options.annotation.query, {}, 'glob');\n    var annotationQuery = {\n      range: options.range,\n      annotation: {\n        name: options.annotation.name,\n        datasource: options.annotation.datasource,\n        enable: options.annotation.enable,\n        iconColor: options.annotation.iconColor,\n        query: query\n      },\n      rangeRaw: options.rangeRaw\n    };\n\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/annotations',\n      method: 'POST',\n      data: annotationQuery\n    }).then(result => {\n      return result.data;\n    });\n  }*/\n\n  metricFindQuery(options, url)\n  {\n    return this._request('GET', 'grafana/' + url, null, options).then(\n      result =>\n      {\n        return this.mapToTextValue(result);\n      });\n  }\n\n  mapToTextValue(result)\n  {\n    var map = _.map(result.data, (d, i) => {\n      return { name: d, id: i };\n    });\n    return map.sort(function (a, b) {\n      return a.name.localeCompare(b.name);\n    });\n  }\n\n  buildQueryParameters(options) {\n    var parameters = {\n      interval: options.intervalMs,\n      from: '\"' + options.range.from.toISOString() + '\"', // dirty hack to be compatible with old API\n      to: '\"' + options.range.to.toISOString() + '\"', // dirty hack to be compatible with old API\n      targets: JSON.stringify(options.targets)\n      /*annotation: {\n      },*/\n    };\n    return parameters\n  }\n}"]}