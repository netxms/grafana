{"version":3,"sources":["../../src/datasource.js"],"names":["NetXMSDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","sessionId","basicAuth","withCredentials","_request","method","data","params","options","headers","datasourceRequest","then","response","query","buildQueryParameters","targets","includes","status","session","message","title","mapToTextValue","result","map","d","i","id","sort","a","b","localeCompare","parameters","interval","intervalMs","from","range","to","JSON","stringify"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\n\nexport class NetXMSDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv)\n  {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.sessionId = 0;\n    this.basicAuth = instanceSettings.basicAuth;\n    this.withCredentials = instanceSettings.withCredentials;\n\n    this._request = function(method, url, data, params) {\n      var options = {\n        url: this.url + \"/\" + url,\n        method: method,\n        data: data,\n        headers: {},\n        params: params\n      };\n\n      if (this.basicAuth || this.withCredentials) {\n        options.withCredentials = true;\n      }\n      if (this.basicAuth) {\n        options.headers[\"Authorization\"] = this.basicAuth;\n      }\n      if (this.sessionId)\n        options.headers[\"Session-Id\"] = this.sessionId;\n\n      return backendSrv.datasourceRequest(options).then(response =>\n        {\n          if (response.headers(\"Session-Id\"))\n            this.sessionId = response.headers(\"Session-Id\");\n          return response;\n        });\n    };\n  }\n\n  query(options)\n  {\n    var query = this.buildQueryParameters(options);\n    if (query.targets.includes(\"type\\\":\\\"Alarms\\\"\"))\n      var url = \"grafana/alarms\";\n    else\n      var url = \"grafana/datacollection\";\n\n    return this._request('GET', url, null, query);\n  }  \n\n  testDatasource()\n  {\n    return this._request('POST', 'sessions', null, null).then(response =>\n    {\n      if (response.status === 200)\n      {\n        this._request('DELETE', 'sessions/' + response.data.session, null, null);\n        return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n      }\n    });\n  }\n\n  /*\n   * Not implemented yet\n   */\n  /*annotationQuery(options) {\n    var query = this.templateSrv.replace(options.annotation.query, {}, 'glob');\n    var annotationQuery = {\n      range: options.range,\n      annotation: {\n        name: options.annotation.name,\n        datasource: options.annotation.datasource,\n        enable: options.annotation.enable,\n        iconColor: options.annotation.iconColor,\n        query: query\n      },\n      rangeRaw: options.rangeRaw\n    };\n\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/annotations',\n      method: 'POST',\n      data: annotationQuery\n    }).then(result => {\n      return result.data;\n    });\n  }*/\n\n  metricFindQuery(options, url)\n  {\n    return this._request('GET', 'grafana/' + url, null, options).then(\n      result =>\n      {\n        return this.mapToTextValue(result);\n      });\n  }\n\n  mapToTextValue(result)\n  {\n    var map = _.map(result.data, (d, i) => {\n      return { name: d, id: i };\n    });\n    return map.sort(function (a, b) {\n      return a.name.localeCompare(b.name);\n    });\n  }\n\n  buildQueryParameters(options) {\n    var parameters = {\n      interval: options.intervalMs,\n      from: options.range.from,\n      to: options.range.to,\n      targets: JSON.stringify(options.targets)\n      /*annotation: {\n      },*/\n    };\n    return parameters\n  }\n}"]}