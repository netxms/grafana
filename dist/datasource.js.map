{"version":3,"sources":["../src/datasource.js"],"names":["_","NetXMSDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","sessionId","basicAuth","withCredentials","_request","method","data","params","options","headers","datasourceRequest","then","response","query","buildQueryParameters","targets","includes","status","session","message","title","mapToTextValue","result","map","d","i","id","sort","a","b","localeCompare","parameters","interval","intervalMs","from","range","to","JSON","stringify"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\n\nexport class NetXMSDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv)\n  {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.sessionId = 0;\n    this.basicAuth = instanceSettings.basicAuth;\n    this.withCredentials = instanceSettings.withCredentials;\n\n    this._request = function(method, url, data, params) {\n      var options = {\n        url: this.url + \"/\" + url,\n        method: method,\n        data: data,\n        headers: {},\n        params: params\n      };\n\n      if (this.basicAuth || this.withCredentials) {\n        options.withCredentials = true;\n      }\n      if (this.basicAuth) {\n        options.headers[\"Authorization\"] = this.basicAuth;\n      }\n      if (this.sessionId)\n        options.headers[\"Session-Id\"] = this.sessionId;\n\n      return backendSrv.datasourceRequest(options).then(response =>\n        {\n          if (response.headers(\"Session-Id\"))\n            this.sessionId = response.headers(\"Session-Id\");\n          return response;\n        });\n    };\n  }\n\n  query(options)\n  {\n    var query = this.buildQueryParameters(options);\n    if (query.targets.includes(\"type\\\":\\\"Alarms\\\"\"))\n      var url = \"grafana/alarms\";\n    else\n      var url = \"grafana/datacollection\";\n\n    return this._request('GET', url, null, query);\n  }  \n\n  testDatasource()\n  {\n    return this._request('POST', 'sessions', null, null).then(response =>\n    {\n      if (response.status === 200)\n      {\n        this._request('DELETE', 'sessions/' + response.data.session, null, null);\n        return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n      }\n    });\n  }\n\n  /*\n   * Not implemented yet\n   */\n  /*annotationQuery(options) {\n    var query = this.templateSrv.replace(options.annotation.query, {}, 'glob');\n    var annotationQuery = {\n      range: options.range,\n      annotation: {\n        name: options.annotation.name,\n        datasource: options.annotation.datasource,\n        enable: options.annotation.enable,\n        iconColor: options.annotation.iconColor,\n        query: query\n      },\n      rangeRaw: options.rangeRaw\n    };\n\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/annotations',\n      method: 'POST',\n      data: annotationQuery\n    }).then(result => {\n      return result.data;\n    });\n  }*/\n\n  metricFindQuery(options, url)\n  {\n    return this._request('GET', 'grafana/' + url, null, options).then(\n      result =>\n      {\n        return this.mapToTextValue(result);\n      });\n  }\n\n  mapToTextValue(result)\n  {\n    var map = _.map(result.data, (d, i) => {\n      return { name: d, id: i };\n    });\n    return map.sort(function (a, b) {\n      return a.name.localeCompare(b.name);\n    });\n  }\n\n  buildQueryParameters(options) {\n    var parameters = {\n      interval: options.intervalMs,\n      from: options.range.from,\n      to: options.range.to,\n      targets: JSON.stringify(options.targets)\n      /*annotation: {\n      },*/\n    };\n    return parameters\n  }\n}"]}